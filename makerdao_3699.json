{
    "poll_list": [],
    "discourse_list": [
        {
            "thread_link": "https://forum.makerdao.com/t/proposal-upgrading-the-flopper/835",
            "title": "Proposal: Upgrading the Flopper ",
            "index": 835,
            "category": [
                "Governance"
            ],
            "tags": [
                "proposal"
            ],
            "content": [
                {
                    "author_link": "https://forum.makerdao.com/u/Mariano_Conti",
                    "index": "#1",
                    "likes": "6",
                    "time": "21/11/2019-21:11:03",
                    "content": "Introduction After the Multi Collateral Dai (MCD) contracts were deployed to the Ethereum mainnet on November 15th, a minor bug was discovered in the debt auction contract, also known as the Flopper. The discovered bug will only affect the system if debt auctions are active during Emergency Shutdown, in which case it prevents their cancellation. It was felt that this issue did not constitute an impediment to activation of the MCD system for a few reasons :  The issue with MKR authorization and debt auctions discussed in the MKR Authority Transfer post was a more serious concern that also did not block activation. Governance parameters were already in the process of being chosen to make debt auctions unlikely until the MKR authorization issue could be resolved, making it very unlikely that this bug would be encountered (since it further requires Emergency Shutdown). In a worst-case scenario, the bug would not block Emergency Shutdown from occurring but would change its execution behavior.  However, now that the system is active, it is important to patch the bug promptly. The patch will require a new Flopper contract to be deployed and voted into the system via the governance process. The Bug The specific issue comes from the yank(uint id) function of the Flopper. This function is supposed to refund the last bidder on the auction specified by id during Emergency Shutdown since new bids (via dent ) and auction finalization (via deal ) are disabled after Shutdown. In the version with the bug, the Vat\u2019s move function is used to attempt to transfer (internal) Dai from the Flopper to the last bidder (line 153). The issue with this is that during the bidding process, the Flopper never receives any Dai! The first bid goes directly to the Vow\u2019s balance, and subsequent bids just refund the previous bidder. Thus, if this function were to be called in a real-world scenario, it would revert due to an underflow check in move . Note: For this section, refer to this version of the Flopper, which is a \u201cpre-fix\u201d, so that the bug can still be seen. Also, recall that a debt (or \u201cflop\u201d) auction prints MKR to cover unbacked Dai\u2014for a fixed amount of Dai, bidders compete to see who will accept the least quantity of MKR in return. Thus, bidders pay in Dai, and the winner receives MKR, with all but the final bidder receiving a refund. Impact of the Bug Overall, the discovered bug has no effect on the system during normal operation. There is also no effect if no active (i.e. bid-on) debt auctions exist when Emergency Shutdown is triggered. The direct impact of this bug will only occur if Emergency Shutdown is triggered, resulting in the active debt auctions of the system becoming unable to be canceled. This leads to two indirect impacts:  The last Auction Keeper to bid on an outstanding debt auction loses its Dai bid, receiving nothing in return as Shutdown freezes both the ability to bid on and the finalizing of debt auctions (as auction cancellation is intended to refund bids in this situation). Since the un-refunded bids are absorbed into the system surplus, the total debt is decreased, and thus the quantity of each collateral type awarded per Dai is increased (at the expense of the debt auction Keepers).  The Patch Multiple technical solutions were considered. They were judged based on the following criteria:  Minimizing changes to the debt auction mechanism\u2014many of our partners have tested and integrated with this mechanism, and changing it could be disruptive or accidentally introduce other bugs. Replacing as few contracts as possible\u2014without a compelling need to change more than one contract, this minimized technical complexity and risk. Harmony with the design and intent of the rest of the system.  Explanation of the Patch The chosen solution is to change the move call to a suck call in yank . With the appropriate choice of parameters, this credits Dai to the last bidder as a refund while the Vow\u2019s sin balance (i.e. unbacked debt) is increased to offset the refund. This solution does require the Flopper to be authorized to call protected functions of the Vat ( suck requires authorization). However, it allows us to keep the auction mechanism as close to the version that has been tested on testnets leading up to launch. The commit that applies the fix to the main MCD repository can be found here. Steps to Integrate the New Flopper  Deploy the fixed Flopper contract to mainnet. The deployer uses the Flopper\u2019s rely function to grant calling permissions to the Vow and Governance Pause Proxy; the deployer then calls deny to deauthorize itself. The new Flopper is given permission to mint MKR via the MkrAuthority (this will be done as part of the MKR Authority Transfer) An executive vote must be held to elect a spell that will call the Vat\u2019s rely method to give the new Flopper contract permission to call suck and will call file on the Vow to set the new flopper address value.  Looking Back How did this bug make it into the mainnet deployment? A few factors can be identified:  Formal Verification (FV) is not a perfect solution. In this case, it did not catch this bug because the function-level specs were written in such a way that it mirrored the bug in the source code. A higher level multi-transaction FV that would catch such a bug even with function-level errors is still a work in progress. This bug exists only when two rare scenarios take place at the same time. It is extremely rare in software development to have a completely bug-free system. This is why the MakerDAO system was designed to be modular and upgradeable and why we will be working with Governance to roll out initiatives to secure and improve the system in the future.  We will also be introducing our MIPs program in the near future which will introduce a simple, standard approach for Maker stakeholders and our community members to propose new improvements, standard specifications, or process changes for the Maker Protocol. Next Steps  Executive vote for Flopper patch. In terms of the timing of this patch, it is required that it is done when the Flopper is enabled. The Maker Foundation will inform integration partners that there are no backward-compatible issues.  ",
                    "links": [
                        "https://docs.makerdao.com/smart-contract-modules/shutdown#overview-of-the-shutdown-process",
                        "https://forum.makerdao.com/t/mkr-token-authority-transfer/836",
                        "https://github.com/makerdao/dss/blob/6fd7de01e3807e65edbcab52591828d93adea539/src/flop.sol#L150",
                        "https://github.com/makerdao/dss/blob/6fd7de01e3807e65edbcab52591828d93adea539/src/flop.sol#L153",
                        "https://docs.makerdao.com/smart-contract-modules/system-stabilizer-module/vow-detailed-documentation",
                        "https://github.com/makerdao/dss/blob/6fd7de01e3807e65edbcab52591828d93adea539/src/flop.sol",
                        "https://docs.makerdao.com/keepers/auction-keepers",
                        "https://github.com/makerdao/dss/commit/870d6fddb75090eb177290b1db4e255d2c31075e",
                        "https://forum.makerdao.com/t/mkr-token-authority-transfer/836",
                        "https://forum.makerdao.com/t/signal-request-how-do-we-handle-executive-bundling-in-relation-to-technical-changes/965",
                        "https://forum.makerdao.com/t/dark-fix-mechanism-a-proposal-for-handling-critical-vulnerabilities-in-the-maker-protocol/1297/12"
                    ],
                    "GPT-summary": "The post explains a bug that was discovered in the debt auction contract of the Multi Collateral Dai (MCD) system and the impact it could have during Emergency Shutdown. The post also provides a technical solution to patch the bug and the steps to integrate the new Flopper contract. The author also reflects on how the bug made it into the mainnet deployment and the initiatives to secure and improve the system in the future. The post also mentions the upcoming MIPs program for proposing new improvements or process changes for the Maker Protocol.",
                    "GPT-proposal-categories": null,
                    "GPT-discussion-categories": [
                        "Author of proposal is explaining proposal",
                        "None"
                    ],
                    "Sentiment": 5.164797323888233
                }
            ]
        }
    ]
}