{
    "poll_list": [],
    "discourse_list": [
        {
            "thread_link": "https://forum.makerdao.com/t/curve-lp-token-oracle-manipulation-vulnerability-technical-postmortem/18009",
            "title": "Curve LP Token Oracle Manipulation Vulnerability Technical Postmortem ",
            "index": 18009,
            "category": [
                "Core Units",
                "Protocol Engineering"
            ],
            "tags": [
                "post-mortem",
                "pe-001"
            ],
            "content": [
                {
                    "author_link": "https://forum.makerdao.com/u/Kurt_Barry",
                    "index": "#1",
                    "likes": "17",
                    "time": "20/09/2022-15:10:16",
                    "content": "Start: 2022-03-14 14:00:35 UTC End: 2022-04-27 14:00:37 UTC Authors: Kurt Barry (kmbarry1) Status: Resolved Summary: On April 14th, 2022 the Curve team reached out and alerted the MakerDAO Protocol Engineering Core Unit (PECU) to a vulnerability in our steCRV (ETH-stETH pool) oracle due to a reentrancy manipulation of the underlying Curve pool. Specifically, the value returned by get_virtual_price() would be erroneously high if it were called during a withdrawal from the Curve pool. Since the oracle relies on get_virtual_price(), the attack would involve calling poke() on the oracle during the withdrawal (triggered by the transfer of raw ETH to the recipient address). MakerDAO core units and vote delegates coordinated to freeze the oracles to ensure no exploit could occur. A fix for the oracle was then developed and included in the April 22nd, 2022 executive proposal, which was executed on April 27th 2022, reenabling full functionality of the CRVV1ETHSTETH-A collateral. The incident response is examined in a separate postmortem; this document focuses on the processes that allowed a vulnerability to enter the production system and remain undetected for several weeks. Impact: Significant disruption to MakerDAO stakeholders, and diversion of resources away from planned work to incident response and mitigation. Additionally, CRVV1ETHSTETH-A Vault holders experienced degraded functionality for almost two weeks (could not draw additional debt, could not withdraw collateral without repaying all debt). Root Causes: The primary root cause was insufficient scrutiny of an external contract that integrated with Maker components. The reasons for this insufficient scrutiny are detailed below.  Long track record of the integrated contract and method of integration (\u201cLindyness\u201d). Curve pools have been in use for an extended period of time, and the ETH-stETH pool itself was not particularly new. Further, the use of the get_virtual_price() to value Curve LP oracle tokens followed the exact same pattern used by other projects (e.g. Alpha Finance, Rari Capital), and those existing implementations had not experienced hacks in their time on mainnet. This contributed to a high level of confidence in the safety of the implementation, which was in hindsight unjustified. General resource constraints. The oracle implementation received the customary unit and integration tests, multiple internal code reviews, and an audit, but none of these efforts probed particularly deeply into the Curve code, which was itself non-trivial. Doing so would have required additional resources, which were already allocated elsewhere.  Of course, research of in-depth complex integrations must be balanced against any desired execution cadence. In this case, the Curve pool code was probably simple enough that this would not have been unreasonable, although still costly. PECU team members had previously studied aspects of Curve code, particularly the mathematical implementation, in some detail; this contributed to a high confidence level that overlooked the unique aspects of the steCRV pool (handling raw Ether). This could potentially have been discovered using automated tooling or an integration checklist that could flag a common security issue like sending raw Ether proactively. Trigger: Vulnerable oracle implementation deployed to production. Resolution: A fixed oracle with a poke() function that reverts if reentrancy is attempted from the Curve pool was integrated into the Maker protocol, safely reenabling the CRVV1ETHSTETH-A collateral type. Detection: ChainSecurity found a similar issue in unrelated code, which prompted them to check for analogous issues in previously-audited smart contracts. The found such bugs in certain Curve pools and notified the Curve team, with whom they then collaborated to perform disclosures to other projects, including MakerDAO. Action Items:     Action Item Type Owner (GH handle) Ticket     Define heuristics and/or checklists for when external integrations require deeper study Prevent kmbarry1 1088   Research generalized, automated detection of integration vulnerabilities Prevent kmbarry1 1090   Define guidelines for how quickly debt ceiling increases should be done based on technical risk Risk Management godsflaw 1089     Lessons Learned What Went Well:  The issue was discovered and mitigated prior to any exploitation. The gradual debt ceiling increase process meant that the potential severity was limited. The vulnerability was reported one day before an executive was scheduled to go out that would have raised the debt ceiling from 5 million to 50 million DAI, so this was very timely (and lucky). An acceptable fix was developed and deployed swiftly.  What Went Wrong:  Internal review, testing, and audits all missed the vulnerability. The team\u2019s assessment of the need to audit the integration more deeply (low) was inconsistent with the actual need (high). The significant danger posed by oracle manipulation, along with the use of a security anti-pattern (handling of raw ETH) by the integrated contract should have flagged this as a risky integration that required more careful scrutiny.   Timeline All times UTC. See the incident response postmortem for a more detailed timeline following detection. 2022-03-14 14:00:35: CRVV1ETHSTETH-A is onboarded with the vulnerable oracle. 2022-04-14 17:15: Michael Egorov of Curve notifies godsflaw of the vulnerability. 2022-04-14 22:27:38: CRVV1ETHSTETH-A oracle is frozen by an out-of-band executive spell. 2022-04-18 22:04: Tentative fix for the oracle is completed and shared with a subset of PECU team members for review. 2022-04-19: A superior way to prevent reentrancy is discovered (remove_liquidity instead of withdraw_admin_fees). 2022-04-25 13:02:07: spell to replace the vulnerable oracle is scheduled for execution. 2022-04-27 14:00:37: spell integrating the fixed oracle is cast.  Supporting Information Commit with confirmation of bug and fix ",
                    "links": [
                        "https://forum.makerdao.com/t/curve-lp-token-oracle-manipulation-vulnerability-emergency-response-postmortem/18011",
                        "https://github.com/makerdao/smart-contracts-team-pm/issues/1088",
                        "https://github.com/makerdao/smart-contracts-team-pm/issues/1090",
                        "https://github.com/makerdao/smart-contracts-team-pm/issues/1089",
                        "https://github.com/makerdao/curve-lp-oracle/commit/302f5e6966fdbfebe0f7063c9d6f6bc1f6470f28",
                        "https://forum.makerdao.com/t/curve-lp-token-oracle-manipulation-vulnerability-emergency-response-postmortem/18011",
                        "https://forum.makerdao.com/t/weekly-forum-recap/16247/18",
                        "https://forum.makerdao.com/t/postmortem-tecnico-de-la-vulnerabilidad-de-manipulacion-de-tokens-curve-lp-traduccion/18038"
                    ],
                    "GPT-summary": "The post is a technical postmortem of a vulnerability in the Curve LP Token Oracle Manipulation. The vulnerability was discovered by the Curve team and reported to the MakerDAO Protocol Engineering Core Unit (PECU). The postmortem examines the processes that allowed the vulnerability to enter the production system and remain undetected for several weeks. The post also discusses the impact of the vulnerability and the action items taken to prevent similar incidents in the future.",
                    "GPT-proposal-categories": null,
                    "GPT-discussion-categories": [
                        "Author of proposal is explaining proposal",
                        "None",
                        "None"
                    ],
                    "Sentiment": 5.320037724832245
                },
                {
                    "author_link": "https://forum.makerdao.com/u/system",
                    "index": "#2",
                    "likes": "0",
                    "time": "19/12/2022-15:10:38",
                    "content": "This topic was automatically closed 90 days after the last reply. New replies are no longer allowed. ",
                    "links": [],
                    "GPT-discussion-categories": null,
                    "Sentiment": 5.0606060606060606
                }
            ]
        },
        {
            "thread_link": "https://forum.makerdao.com/t/curve-lp-token-oracle-manipulation-vulnerability-emergency-response-postmortem/18011",
            "title": "Curve LP Token Oracle Manipulation Vulnerability - Emergency Response Postmortem ",
            "index": 18011,
            "category": [
                "Core Units"
            ],
            "tags": [
                "governance",
                "post-mortem",
                "pe-001"
            ],
            "content": [
                {
                    "author_link": "https://forum.makerdao.com/u/Derek",
                    "index": "#1",
                    "likes": "17",
                    "time": "20/09/2022-15:47:49",
                    "content": " Curve LP Token Oracle Manipulation Vulnerability - Emergency Response Postmortem Posting in parallel with the Technical Postmortem, since we have been given the all clear that no funds are at risk.  Summary On April 14th, 2022 the Curve team reached out and alerted the MakerDAO Protocol Engineering Core Unit (PECU) to a vulnerability in our steCRV (ETH-stETH pool) oracle due to a reentrancy manipulation of the underlying Curve pool. MakerDAO core units and vote delegates coordinated to freeze the oracles to ensure no exploit could occur. A fix for the oracle was then developed and included in the April 22nd, 2022 executive proposal, which was executed on April 27th 2022, reenabling full functionality of the CRVV1ETHSTETH-A collateral. This document covers the incident response process that took place once the MakerDAO Protocol Engineering Core Unit (PECU) was alerted to the issue. The process failures that allowed a vulnerability to enter the production system and remain undetected for several weeks are covered in a separate technical postmortem.  What Went Well  Recognized Delegate Response Most Recognized Delegates responded to initial contact within 1 hour. Combined, the responders had enough MKR to pass an executive vote. However this should be caveated that the communication took place during \u2018prime time\u2019, and just a couple of hours after the Governance and Risk Meeting. Recognized Delegates and contacted MKR Holders generally responded well to emergency contact and the request that they remain on-call, despite the very limited amount of information that had been shared with them at that point. At the point we were ready for the delegates to vote, those that had responded initially were able to understand the issue and mitigation as described by Kurt in a war-room call and voted to pass the executive spell. The spell was passed within 30 minutes of us receiving the go signal from Chain Security.  External Engineering Relationships The Protocol Engineering Core Unit was one of the first groups to be informed of an issue that affected multiple protocols. This is largely due to pre-existing positive relationships between individuals within that unit, and other developers in the larger ecosystem. Chainsecurity also informed the Protocol Engineering Core Unit about the issue slightly later, but still extremely quickly given the circumstances.  General Caution and \u2018Lindy\u2019 Delay on Debt Ceiling Increases We were able to avert a planned debt ceiling raise for the affected Vault type that would have greatly increased the risk of the vulnerability, as a result of our caution over rapidly increasing debt ceilings on vault types employing newly produced code. Main caveat here is that we only just averted it by ~24 hours.  What Went Badly  Response Time Response time was not as quick as it would have needed to be if the first we\u2019d known of this vulnerability was an entity exploiting it. We did not have a pre-built spell or spell template that was capable of freezing the steCRV (ETH-stETH pool) oracle. It took us longer than an hour to get to the point where the spell was deployed and ready to go. Further, it would likely have taken us longer than an hour to organise MKR response if this had happened outside of peak times.  Recognized Delegate Contact GovAlpha has not systematically collected and maintained offline contact information (ie phone numbers) for Recognized Delegates. This likely contributed to our inability to get responses from some Recognized Delegates as swiftly as we would have liked.  Communications with MakerDAO and Other Stakeholders Communications were extremely hard to manage throughout this process because the Maker Protocol was not the only protocol affected by the issue. We wanted to keep the DAO as informed as possible, while also not burning bridges and potentially causing financial loss for users of other protocols. It was very unclear how much we were allowed to disclose at any point, even a week after the initial mitigation. Our initial forum post was deemed to be too revealing, and was edited heavily a few hours after it was posted. The original version was only restored ~8 days later. Publication of this postmortem has been delayed due to on-going mitigations happening in other protocols.  Leadership in Response Group was Unclear At no point during the response, or in the weeks afterward, was there a clearly defined leader / incident response commander / etc. We don\u2019t believe this meaningfully impacted the response in this case, but the potential was there for it to do so. The two examples of issues related to this were:  There was a coordination failure over alerting tech-ops to what was going on. There was general agreement they should be notified, but no one actually did it prior to us being ready to implement the initial mitigation. There was some frustration in the days following from most in the group over the general communications constraints. Everyone was reluctant to make a decision on how much or little we should communicate, and when.   The Voting Portal UI Did Not Allow Voting on an Arbitrary Spell Address We expected the Voting Portal to allow delegates to vote on an executive spell located at an arbitrary ethereum address. This functionality may have been present at one point, but was no longer present on the night in question. This caused a ~10 minute delay as we wrote and submitted placeholder executive copy which would allow the Portal to display the emergency executive as available for voting.  Importance Score Lacked Context As part of communications with Recognized Delegates we provided an \u2018Importance Score\u2019 so they could decide to what extent they should disrupt their plans in favour of emergency response for Maker. While we believe this was useful, the score lacked context and was rather arbitrary due to the limited information available to us. We went with 6/10, which may have been an overestimation, and probably meant wildly different things to different delegates.  Immunefi Security Core Unit\u2019s Role It was unclear to what extent Immunefi Security should be involved in emergency response procedures. The decision was made to not involve them, as those individuals that were needed to affect a mitigation were already present and informed.  Action Items  Shared [PE/GovAlpha/MakerDAO] Ensure 1-hour Response Time Is Achievable We need to do more to try to ensure that reaction within 1-hour is realistically possible regardless of time and day. Protocol Engineering and GovAlpha have discussed this briefly and have several ideas. However, nothing we\u2019ve come up with so far is obviously the right decision when considering the costs. Current ideas include:  Make it much much faster to have proposals ready for delegates to vote on.  Permissionless factory contracts. Pre-deployed spells.   IAM similar to the ESM that allows an arbitrary amount of MKR to trigger oracle freezes, with non-emergency actions resulting in that MKR being burned. Empower a multi-sig contract with permission to freeze MakerDAO\u2019s Oracles. Some hybrid of the above.  If anyone has additional ideas on how we could achieve this, please share them with us. [PE/Immunefi] Ensure both groups are aligned on division of responsibilities with respect to technical and non-technical emergency response.  GovAlpha  Ensure internal emergency response procedures are documented. Ensure relevant stakeholders have demonstrated familiarity with the emergency response procedures. Maintain contact information for Recognized Delegates. Ensure contact information for Recognized Delegates is accessible in an emergency. Document emergency contact expectations for Recognized Delegates.   DUX  Voting Portal support for voting on arbitrary contract addresses. Voting portal support for non-standard executive contracts.   Protocol Engineering (details included in the Technical Post Mortem)  Define heuristics and/or checklists for when external integrations require deeper study Research generalised, automated detection of integration vulnerabilities Define guidelines for how debt ceiling increases should be done based on technical risk   Timeline  Thursday - 2022-04-14 17:15 UTC - Michael from Curve informs cmooney about a bug in the ETH/stETH Curve pool. 17:20 UTC - A subset of the Protocol Engineering Team drop from the G&R call to join a war room discussing options. Michael from Curve joins as well. 18:26 UTC - Brian McMichael informs LongForWisdom there is an issue and shares a war-room link. 18:30 UTC - LFW joins the war-room call and gets an overview of the issue. LFW takes 30 mins to deal with real world stuff. 19:00 UTC - LFW rejoins the war-room call, and Kurt shares the mitigation plan, and confirms that we will need to get in touch with MKR Holders. At this stage very unsure when we will be able to act. LFW decides that 72 hours on-call is a reasonable estimate based on extremely limited information. 19:19 UTC - Hubert from ChainSecurity reaches out to brianmcmichael and confirms the same price manipulation threat, and sets-up a ChainSecurity/Maker Discord Channel. brianmcmichael then added infomorph, godsflaw, tal, gbalabasquer and Derek for coordination. 19:20 UTC - LFW informs Pablo and Patrick (GovAlpha members) that there is an issue (not sharing details) and that we need to get in touch with all the delegates. 19:29 UTC - Derek creates an internal Discord group with LongForWisdom, brianmcmichael, gbalabasquer, godsflaw, infomorph, and Tal. 19:30 UTC - Pablo, Patrick and LFW begin speaking to delegates and some MKR Holders to confirm commitments. 19:40 UTC - LFW, Kurt and Gonzalo attempt to come up with an \u2018importance\u2019 score to share with delegates. Land on 6/10, but this is very arbitrary. 19:40 UTC - Based on feedback from PE, LFW decided to seek 1hr, 4hr and 24hr commitments from delegates. 19:45 UTC - Kurt confirms zero chance of using a dark-spell. 19:45 UTC - List of information shared with delegates + known MKR Holders at this point:  Need 1hr response time for the next 72 hours. If can\u2019t guarantee 1 hr, then 4 hrs, if not 4hr, then 24 hours. Won\u2019t be a dark-spell. 6 / 10 important. Any contact details provided may be shared between GovAlpha, GovComms and Protocol Engineering. Derek from PE is a second point of contract to confirm the above.  19:55 UTC - LFW and Kurt briefly discuss bringing Immunefi and GovComms into conversation. Decided against at this point to avoid widening the circle of knowledge. Confirm we might bring GovComms in later if we need to run shifts. 20:05 UTC - LFW shares current status of governance-side efforts. LFW decides not to contact additional VC\u2019s after a16z at this time, because:  Unlikely they\u2019ll be able to react within an hour, based on prior knowledge, and discussion with a16z. Danger of causing panic and concern, exacerbated by inability to provide any details. Delegates are responding well at this stage, and judged we\u2019ll probably have enough MKR to beat the hat without VCs (though this is yet to be confirmed).  20:45 UTC - LFW releases Pablo. 21:15 UTC - OSM Freeze Spell is completed by Protocol Engineering Core Unit. 21:15 UTC - LFW releases Patrick. 21:25 UTC - LFW rejoins war-room call to report status and coordinate actions. Enough committed for LFW to feel confident we can pass the proposal quickly. Current delegate / MKR Holder commitments (cumulative) at this point:  1-hr Committed - 62,743.87 MKR 4-hr Committed - 65,774.87 MKR 24-hr Committed - 75,774.87 MKR Maybes / No commitment - 10,000 - 50,000 MKR  21:25 UTC - Multiple individuals reach out to TechOps to join the war-room call, mainly to ensure they aren\u2019t taken by surprise by mitigation actions. 21:25 UTC - ChainSecurity informs the Maker team over chat that they \u201chave coordinated with all affected protocols. All protocols that are able to take action today, will take action \u201cnow\u201d (= within the next hour). Feel free to do so also.\u201d 21:30 UTC - LFW informs delegates (largest first) that they will need to vote imminently. 21:30 UTC - LFW and PE discover the voting portal does not (no longer?) support(s) voting on executives at arbitrary ethereum addresses. Immediately attempt to contact Phillip Bain from DUX. 21:40 UTC - Phil responds and joins war-room call. Recommends to write stub-copy and submit the executive in the usual way. 21:40 UTC - TechOps join war-room call. Chris reaches out to Nik from the Oracles Core Unit and he joins shortly afterward. 21:50 UTC - LFW submits stub-copy to the github repo to use on the portal. Executive appears on the portal shortly afterward. 21:55 UTC - LFW shares executive link + war-room link with delegates (largest first). 22:00 UTC - Delegates join the war-room call, Kurt explains the same situation 5 times in succession as various delegates arrive. Delegates vote on executive. 22:30 UTC - Executive Spell is triggered, having gathered enough MKR votes to cast. 22:40 UTC - Start discussing comms with the community about what just happened. Those on war-room call draft the initial post, confirm it, Derek posts and LFW pins it on the Maker Forum. 22:50 UTC - After confirming no other actions expected until Monday, LFW leaves.  Friday - 2022-04-15 00:22 UTC - A further conversation with Curve deems there is too much information in the forum post and Derek removes the detail. 14:18 UTC - Further conversation with Immunefi indicates that other protocols may still be vulnerable and so the post is further redacted and hidden from the portal\u2019s front page. 14:56 UTC - Derek reaches out to Nikola at DFS to remove their Discord notice in light of other protocol\u2019s potential vulnerabilities. Oasis is also informed of the progress.  Monday - 2022-04-18 17:00 UTC - LFW and cmooney inform David Utrobin (GovComms) of the issue, in order to prepare and manage communications responsibilities when we\u2019re more able to communicate. 22:04 UTC - Tentative fix for Curve LP token oracle is completed and shared with a subset of PECU team members for review.  Tuesday - 2022-04-19 18:00 UTC - Catch up between PE and LFW in GovOps call. Still not comfortable communicating openly, though everyone is frustrated. Chris Mooney informs people we\u2019re planning to make a fix on Friday that will reveal some info unless we hear otherwise.  Wednesday - 2022-04-20 16:00 UTC - Catch up async in discord channel. Still no clear communication from other affecting protocols re: comms. No one has responded to Chris, planning to proceed with oracle replacement on Friday.  Thursday - 2022-04-21 14:30 UTC - LFW and David share the executive copy and planned comms in shared discord. Chris passes on to multi-protocol group.  Friday - 2022-04-22 Afternoon - Executive Proposal to replace the oracle is made public. General communications are made to vault holders. Community communications are restored. ",
                    "links": [
                        "https://forum.makerdao.com/t/curve-lp-token-oracle-manipulation-vulnerability-technical-postmortem/18009",
                        "https://forum.makerdao.com/t/weekly-forum-recap/16247/18",
                        "https://forum.makerdao.com/t/postmortem-tecnico-de-la-vulnerabilidad-de-manipulacion-de-tokens-curve-lp-traduccion/18038"
                    ],
                    "GPT-summary": null,
                    "GPT-proposal-categories": null,
                    "GPT-discussion-categories": null,
                    "Sentiment": 5.327178590640129
                },
                {
                    "author_link": "https://forum.makerdao.com/u/Patrick_J",
                    "index": "#2",
                    "likes": "5",
                    "time": "21/09/2022-11:37:04",
                    "content": "Thanks for posting this, Derek. It\u2019s been a long five months since this happened, so it\u2019s good to have everything out in the open finally. Thanks to everyone at PE that worked hard to get this issue fixed quickly and securely. Even though I was only peripherally involved, it felt like we were in safe hands. I just wanted to comment that from GovAlpha\u2019s perspective, the storage of personal contact information of Recognized Delegates has GDPR implications. GovComms (cc: @Davidutro) is currently working on a GDPR-compliant solution and an Emergency Playbook which should cover most if not all of these points. We look forward to this being shared with the community in due course. We\u2019re happy to collaborate on the training end. We will be discussing internally how we can better onboard delegates so the DAO can be more prepared for this kind of intervention. ",
                    "links": [],
                    "GPT-discussion-categories": null,
                    "Sentiment": 6.216666666666667
                },
                {
                    "author_link": "https://forum.makerdao.com/u/simonkp",
                    "index": "#3",
                    "likes": "0",
                    "time": "23/09/2022-23:58:14",
                    "content": "We could develop an app/bot which is accessed through Discord commands to help us run an incident. Here\u2019s how AirBnb does it with Slack - Automated Incident Management Through Slack | by Vlad Vassiliouk | The Airbnb Tech Blog | Jul, 2022 | Medium ",
                    "links": [],
                    "GPT-discussion-categories": null,
                    "Sentiment": 5.0
                }
            ]
        }
    ],
    "group_index": "1756"
}